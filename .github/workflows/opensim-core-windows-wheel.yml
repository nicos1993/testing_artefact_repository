name: opensim-core-windows-wheel

on:
  push:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"  # daily (UTC)

jobs:
  build-wheel:
    runs-on: windows-latest

    env:
      CMAKE_GENERATOR: "Visual Studio 17 2022"
      ARCH: "x64"
      BUILD_TYPE: "Release"
      PYTHON_VERSION: "3.11"   # <- change as needed
      NUMPY_VERSION: "2.*"

      # Install roots (use absolute paths to avoid "~" edge cases on Windows)
      INSTALL_DEPS: ${{ github.workspace }}\install_deps
      INSTALL_CORE: ${{ github.workspace }}\install_core
      BUILD_DEPS:  ${{ github.workspace }}\build_deps
      BUILD_CORE:  ${{ github.workspace }}\build_core

    steps:
      - name: Checkout opensim-core
        uses: actions/checkout@v4
        with:
          repository: opensim-org/opensim-core
          path: opensim-core
          fetch-depth: 1

      - name: Install SWIG (Chocolatey)
        shell: pwsh
        run: |
          choco install swig --version 4.1.1 --yes --limit-output --allow-downgrade
          swig -version

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Python build deps
        shell: pwsh
        run: |
          python -m pip install --upgrade pip
          python -m pip install "numpy==${{ env.NUMPY_VERSION }}" setuptools wheel

      # -------------------------
      # (Optional) Cache deps install to speed up CI
      # Uncomment once you confirm paths are correct
      # -------------------------
      # - name: Cache dependencies install
      #   uses: actions/cache@v4
      #   with:
      #     path: ${{ env.INSTALL_DEPS }}
      #     key: deps-${{ runner.os }}-${{ hashFiles('opensim-core/dependencies/**') }}

      - name: Configure & build dependencies (superbuild)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force "${{ env.BUILD_DEPS }}" | Out-Null
          cmake -S "${{ github.workspace }}\opensim-core\dependencies" `
                -B "${{ env.BUILD_DEPS }}" `
                -G "${{ env.CMAKE_GENERATOR }}" `
                -A "${{ env.ARCH }}" `
                -DCMAKE_INSTALL_PREFIX="${{ env.INSTALL_DEPS }}" `
                -DOPENSIM_WITH_CASADI=ON `
                -DSUPERBUILD_ezc3d=OFF
          cmake --build "${{ env.BUILD_DEPS }}" --config "${{ env.BUILD_TYPE }}" --parallel 4

      # -------------------------
      # (Optional) Cache core install to speed up CI
      # -------------------------
      # - name: Cache core install
      #   uses: actions/cache@v4
      #   with:
      #     path: ${{ env.INSTALL_CORE }}
      #     key: core-${{ runner.os }}-${{ github.sha }}-${{ env.PYTHON_VERSION }}

      - name: Configure & build opensim-core (Python wrapping ON)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force "${{ env.BUILD_CORE }}" | Out-Null
          cmake -S "${{ github.workspace }}\opensim-core" `
                -B "${{ env.BUILD_CORE }}" `
                -G "${{ env.CMAKE_GENERATOR }}" `
                -A "${{ env.ARCH }}" `
                -DOPENSIM_DEPENDENCIES_DIR="${{ env.INSTALL_DEPS }}" `
                -DBUILD_PYTHON_WRAPPING=ON `
                -DBUILD_JAVA_WRAPPING=OFF `
                -DBUILD_TESTING=OFF `
                -DOPENSIM_WITH_CASADI=ON `
                -DOPENSIM_C3D_PARSER=None `
                -DCMAKE_INSTALL_PREFIX="${{ env.INSTALL_CORE }}"
          cmake --build "${{ env.BUILD_CORE }}" --config "${{ env.BUILD_TYPE }}" --parallel 4
          cmake --install "${{ env.BUILD_CORE }}" --config "${{ env.BUILD_TYPE }}"

      - name: Build Python wheel
        shell: pwsh
        run: |
          Set-Location "${{ env.INSTALL_CORE }}\sdk\Python"
          python setup.py bdist_wheel
          Get-ChildItem -Path ".\dist" -Filter "*.whl" | Format-List

      # (Optional) Smoke test: install wheel and import opensim
      # - name: Smoke test wheel (import)
      #  shell: pwsh
      #  run: |
      #    $wheel = Get-ChildItem "${{ env.INSTALL_CORE }}\sdk\Python\dist\*.whl" | Select-Object -First 1
      #    python -m pip install --force-reinstall $wheel.FullName
      #    python -c "import opensim; print('OpenSim import OK')"

      - name: Set build date (for artifact name)
        shell: pwsh
        run: |
          $d = Get-Date -Format "yyyyMMdd"
          "date=$d" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: opensim-core-wheel-win-${{ env.PYTHON_VERSION }}-${{ env.date }}
          path: ${{ env.INSTALL_CORE }}\sdk\Python\dist\*.whl
